{% extends 'admin_app/base.html' %}

{% block title %}Dashboard - Admin{% endblock %}

{% block content %}
<div class="page-title"><i class="bi bi-speedometer2"></i> Dashboard</div>

<!-- Crypto Analysis Stats -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card">
            <div class="card-body">
                <h6 class="card-title text-muted">Current Price (BTC)</h6>
                <h3>${{ crypto_analysis.latest_price }}</h3>
                <small
                    class="{% if crypto_analysis.price_change >= 0 %}text-success{% else %}text-danger{% endif %}"
                >
                    <i
                        class="bi bi-{% if crypto_analysis.price_change >= 0 %}graph-up{% else %}graph-down{% endif %}"
                    ></i>
                    {{ crypto_analysis.price_change }} ({{ crypto_analysis.price_change_percent }}%)
                </small>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card">
            <div class="card-body">
                <h6 class="card-title text-muted">Trend</h6>
                <h3
                    class="{% if crypto_analysis.trend == 'BULLISH' %}text-success{% else %}text-danger{% endif %}"
                >
                    {{ crypto_analysis.trend }}
                </h3>
                <small>SMA 7: ${{ crypto_analysis.sma_7 }}</small>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card">
            <div class="card-body">
                <h6 class="card-title text-muted">RSI (14)</h6>
                <h3>{{ crypto_analysis.rsi }}</h3>
                <small>
                    {% if crypto_analysis.rsi > 70 %}
                    <span class="badge bg-danger">Overbought</span>
                    {% elif crypto_analysis.rsi < 30 %}
                    <span class="badge bg-success">Oversold</span>
                    {% else %}
                    <span class="badge bg-warning">Neutral</span>
                    {% endif %}
                </small>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card">
            <div class="card-body">
                <h6 class="card-title text-muted">Range (30 Days)</h6>
                <small
                    >High: ${{ crypto_analysis.highest_price }}</small>
                <br />
                <small
                    >Low: ${{ crypto_analysis.lowest_price }}</small>
            </div>
        </div>
    </div>
</div>

<!-- Candlestick Chart -->
<div class="card">
    <div class="card-header">
        <h5 class="mb-0">Bitcoin Candlestick Chart (30 Days)</h5>
    </div>
    <div class="card-body">
        <div class="chart-container" style="position: relative; height: 500px">
            <canvas id="candlestickChart"></canvas>
        </div>
    </div>
</div>

<!-- OHLC Values Table -->
<div class="card mt-4">
    <div class="card-header">
        <h5 class="mb-0">Daily OHLC Values</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Open</th>
                        <th>High</th>
                        <th>Low</th>
                        <th>Close</th>
                        <th>Change</th>
                    </tr>
                </thead>
                <tbody id="ohlcTable">
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Chart Libraries -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1/dist/chartjs-adapter-luxon.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@0.2.1/dist/chartjs-chart-financial.min.js"></script>

<script>
    // Register the financial controller
    if (typeof ChartFinancial !== 'undefined') {
        Chart.register(ChartFinancial);
        console.log('Financial controller registered successfully');
    } else {
        console.error('ChartFinancial is not defined!');
    }

    // Candlestick data from Django context
    const candleData = {{ candlestick_data|safe }};

    console.log('Candlestick data:', candleData);
    console.log('Number of data points:', candleData ? candleData.length : 0);

    if (!candleData || candleData.length === 0) {
        console.error('No data available');
        document.getElementById('candlestickChart').innerHTML = '<div class="alert alert-warning">No data available</div>';
    } else {
        // Prepare data for Chart.js candlestick format
        const chartData = candleData.map(candle => {
            const date = new Date(candle.x);
            return {
                x: date.getTime(), // Use timestamp
                o: parseFloat(candle.o),
                h: parseFloat(candle.h),
                l: parseFloat(candle.l),
                c: parseFloat(candle.c)
            };
        });

        console.log('Prepared chart data:', chartData);

        // Sort by date
        chartData.sort((a, b) => a.x - b.x);

        const ctx = document.getElementById('candlestickChart');

        if (!ctx) {
            console.error('Canvas element not found!');
        } else {
            try {
                const chart = new Chart(ctx, {
                    type: 'candlestick',
                    data: {
                        datasets: [{
                            label: 'Bitcoin Price',
                            data: chartData,
                            borderColor: 'rgb(0, 0, 0)',
                            borderWidth: 1,
                            barThickness: 10,
                            // Candle colors
                            color: {
                                up: 'rgb(75, 192, 75)',      // Green for up
                                down: 'rgb(192, 75, 75)',    // Red for down
                                unchanged: 'rgb(125, 125, 125)'  // Gray for unchanged
                            },
                            // Wick colors
                            wickColor: {
                                up: 'rgb(75, 192, 75)',
                                down: 'rgb(192, 75, 75)',
                                unchanged: 'rgb(125, 125, 125)'
                            },
                            // Border colors
                            borderColor: {
                                up: 'rgb(75, 192, 75)',
                                down: 'rgb(192, 75, 75)',
                                unchanged: 'rgb(125, 125, 125)'
                            }
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            },
                            title: {
                                display: true,
                                text: 'Bitcoin Candlestick Chart - 30 Days Analysis',
                                font: {
                                    size: 16,
                                    weight: 'bold'
                                }
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                callbacks: {
                                    label: function(context) {
                                        const data = context.raw;
                                        const date = new Date(data.x).toLocaleDateString();
                                        return `Date: ${date}`;
                                    },
                                    afterLabel: function(context) {
                                        const data = context.raw;
                                        return `Open: $${data.o.toFixed(2)} | High: $${data.h.toFixed(2)} | Low: $${data.l.toFixed(2)} | Close: $${data.c.toFixed(2)}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                type: 'time',
                                time: {
                                    unit: 'day',
                                    displayFormats: {
                                        day: 'MMM dd'
                                    }
                                },
                                title: {
                                    display: true,
                                    text: 'Date',
                                    font: {
                                        weight: 'bold'
                                    }
                                },
                                grid: {
                                    display: false
                                }
                            },
                            y: {
                                beginAtZero: false,
                                title: {
                                    display: true,
                                    text: 'Price (USD)',
                                    font: {
                                        weight: 'bold'
                                    }
                                },
                                ticks: {
                                    callback: function(value) {
                                        return '$' + value.toFixed(2);
                                    }
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                }
                            }
                        }
                    }
                });
                console.log('Chart created successfully');
            } catch (error) {
                console.error('Error creating chart:', error);
                console.error('Error details:', error.message);
                console.error('Error stack:', error.stack);
                document.getElementById('candlestickChart').innerHTML = '<div class="alert alert-danger">Error creating chart: ' + error.message + '</div>';
            }
        }

        // Populate OHLC table
        const tableBody = document.getElementById('ohlcTable');
        candleData.forEach(candle => {
            const row = document.createElement('tr');
            const open = parseFloat(candle.o);
            const close = parseFloat(candle.c);
            const change = (close - open).toFixed(2);
            const changePercent = ((close - open) / open * 100).toFixed(2);
            const changeClass = change >= 0 ? 'text-success' : 'text-danger';
            const changeIcon = change >= 0 ? '▲' : '▼';

            row.innerHTML = `
                <td>${new Date(candle.x).toLocaleDateString()}</td>
                <td>$${open.toFixed(2)}</td>
                <td>$${parseFloat(candle.h).toFixed(2)}</td>
                <td>$${parseFloat(candle.l).toFixed(2)}</td>
                <td>$${close.toFixed(2)}</td>
                <td class="${changeClass}">${changeIcon} $${change} (${changePercent}%)</td>
            `;
            tableBody.appendChild(row);
        });
    }
</script>

{% endblock %}
